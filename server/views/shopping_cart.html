<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>购物车</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="stylesheet" href="{{static_host}}/css/reset.css">
    <link rel="stylesheet" href="{{static_host}}/css/jinping.css">

    <style media="screen">
            *{
            padding: 0;
            margin: 0;
            }
            html,body{
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #f4f4f4;
            }
            p{
            padding: 0;
            margin: 0;
            }
            li{
            list-style: none;
            }
            a{
            text-decoration: none;
            color: #000;
            }
            .head{
            width: 100%;
            height: 46px;
            font-size: 0;
            position: relative;
            overflow: hidden;
            }
            .jiantou{
            display: inline-block;
            width: 32px;
            position: absolute;
            left: 10px;
            top: 13px;
            }
            .head .jiantou img{
            width: 20px;
            height: 20px;
            vertical-align: middle;
            }
            .title{
            display:block;
            width: 200px;
            line-height: 46px;
            font-size: 16px;
            margin: 0 auto;
            text-align: center;
            }
            .menu{
            width: 32px;
            display: inline-block;
            position: absolute;
            right: 10px;
            top: 13px;
            }
            .line{
            width: 100%;
            height: 10px;
            background: #bbbbbb;
            opacity: 0.5;
            }
            .nav{
            width: 100%;
            display: none;
            }
            .nav ul{
            width: 100%;
            display: flex;
            text-align: center;
            background: #404042;
            }
            .nav ul li{
            flex: 1;
            height: 70px;
            font-size: 12px;

            }
            .nav ul li .nav-top{
            width:40px;
            height:30px;
            margin: 0 auto;
            text-align: center;
            line-height: 40px;
            }
            .nav ul li img{
            width:25px;
            height:25px;
            vertical-align: bottom;
            }
            .nav ul li .nav-bottom{
            display: inline-block;
            width: 100%;
            line-height: 40px;
            }
            .nav ul li a{
            color: #fff;
            }
            .nav .nav-car{
            line-height: 57px;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            }
            .list{
            width: 100%;
            margin: 10px 0;
            overflow: auto;
            }
            .list li{
            width: 100%;
            height: 84px;
            position: relative;
            margin-bottom: 15px;
            }
            .circle{
            display: inline-block;
            width: 16px;
            height: 16px;

            position: absolute;
            top: 32px;
            left: 6px;
            }
            .circle img{
            width: 16px;
            height: 16px;
            }
            .list_infor{
            background: #fff;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 99;
            overflow: hidden;
            padding: 5px 0;
            }
            .list .img{
            display: inline-block;
            width: 23.4666%;
            height: 84px;
            padding-left:10.66666%;
            }
            .list .img img{
            width: 100%;
            height: 84px;
            vertical-align: middle;
            }
            .infor{
            display: inline-block;
            font-size: 12px;
            vertical-align: top;
            max-width: 60.3333333%;
            width: 60.3333333%;
            }
            .infor .infor-three .price{
            display: inline-block;
            font-size: 12px;
            color: red;

            overflow: hidden;
            vertical-align: middle;
            }

            .infor .infor-three .add{
            display: inline-block;
            vertical-align: middle;
            float: right;
            overflow: hidden;
            width: 60px;
            }
            .infor .infor-one{
            height: 42px;
            line-height: 20px;
            font-size: 13px;
            vertical-align: top;
            width: 100%;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;

            }
            .infor .infor-two{
            font-size: 13px;
            height: 15px;
            }
            .infor .infor-three .red{
            font-size: 16px;
            font-weight: 400;
            }

            .infor .infor-three .add span{
            box-sizing: border-box;
            float: left;


            }
            input{
            width: 20px;
            height: 20px;
            line-height: 14px;
            border: 1px solid #bbbbbb;
            vertical-align:top;
            box-sizing: border-box;
            text-align: center;
            }
            input {
            -webkit-appearance: none;
            border-radius: 0;
            -webkit-border-radius:0;
            }
            .infor .infor-three .add span:first-child{
            display: inline-block;
            width: 20px;
            height:20px;
            line-height: 20px;
            text-align: center;
            border-right: 0;
            background: #f5f5f5;
            }
            .infor .infor-three .add span:last-child{
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-left: 0px;
            background: #ccc;
            }
            .update_num{
            border: none;
            }

            .footer{
            border-top: 1px solid #eee;
            width: 100%;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            color: #707070;
            background: #fff;
            z-index: 999;
            }
            .footer-left{
            float: left;
            text-indent: 10px;
            width: 25%;
            height: 60px;
            line-height: 60px;
            font-size: 14px;
            }
            .footer-left .bottom img{
            width: 16px;
            height: 16px;
            vertical-align: sub;
            }
            .footer-center{
            float: left;
            width: 50%;
            height: 60px;
            overflow: hidden;
            }
            .footer-center .footer-span1{
            font-size: 12px;
            }
            .footer-center .footer-center-top{
            margin-top: 12px;
            }
            .footer-center .footer-center-top .footer-span2{
            font-size: 16px;
            color: #D81E06;
            }
            .footer-center .footer-center-bottom span:last-child{
            margin-left: 5px;
            }
            .footer-center p{
            /*line-height: 26px;*/
            box-sizing: border-box;
            }
            .footer-right{
            float: right;
            width:25%;
            height: 60px;
            line-height: 60px;
            background: #D81E06;
            text-align: center;
            font-size: 16px;
            color: #fff;
            }
            .behind {
            width: 68px;
            height: 91px;
            line-height: 84px;
            position: absolute;
            top: 2px;
            right: 0;
            bottom: 0;
            background: #D81E06;
            text-align: center;
            color: #fff;
            }
            .none{
            width: 100%;
            height: 300px;;
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 300px;
            }

            .mendian_name{
                font-size: 12px;
                padding: 5px 10px;
                margin-top: 7px;
                background: #fff;
                border-bottom: 1px solid #eee;
            }
            .footer_zhanwei{
              height: 90px;
              text-align: center;
              font-size: 12px;
              color: #333;
            }
    </style>
  </head>
  <body>
    <div id="content">
        <div class="head">
          <span class="jiantou"><img src="{{static_host}}/images/jiantou.png" alt=""></span>
          <span class="title">购物车</span>
          <span class="menu"><img src="{{static_host}}/images/menu.png" alt=""></span>
        </div>
        <div class="line"></div>
        <div class="nav">
          <ul>
            <li>
              <a href="/" style="block:inline-block;">
                <p class="nav-top"><img src="{{static_host}}/images/shouye-4.png" alt=""></p>
                <p class="nav-bottom">首页</p>
              </a>
            </li>
            <li>
              <a href="/search_area">
                <p class="nav-top"><img src="{{static_host}}/images/search-1.png" alt=""></p>
                <p class="nav-bottom">搜索</p>
              </a>
            </li>
            <li>
              <a href="/sort">
                <p class="nav-top"><img src="{{static_host}}/images/fenlei4.png" alt=""></p>
                <p class="nav-bottom">分类</p>
              </a>
            </li>
            <li>
              <a href="/person_center">
                <p class="nav-top"><img src="{{static_host}}/images/header-3.png" alt=""></p>
                <p class="nav-bottom">我的</p>
              </a>
            </li>
          </ul>
        </div>
        <div id="carts"></div>

        <script src="{{static_host}}/js/lodash.min.js" type="text/javascript"></script>
        <script id="empty_cart" type="text/template">
            <p class="none">购物车感觉身体被掏空，请您再逛逛</p>
        </script>
        <script id="cart_infos" type="text/template">
            <ul class="list">
            <% _.forEach(mendians_list, function(mendian) {  %>
                <p class="mendian_name">门店：<%- mendian %></p>
                <% _.forEach(mendians_map[mendian], function(shopping_cart) {  %>
              <li>
                <div class="behind delete" data-id="<%- shopping_cart.id %>">
                  删除
                </div>
                <div class="list_infor">
                  <span class="circle" data-id="<%- shopping_cart.id %>" data-select="<%- shopping_cart.is_selected %>">
                   <% if(shopping_cart.is_selected == 0){ %>
                      <img src="{{static_host}}/images/circle.png" alt="">
                   <% }else{ %>
                      <img src="{{static_host}}/images/xuanzhong.png" alt="">
                   <% } %>
                  </span>

                  <span class="img">
                        <a href="/product_show?product_id=<%- shopping_cart.product_id %>">
                            <% if(products[shopping_cart.product_id]){ %>
                                <% if(products[shopping_cart.product_id].img){ %>
                                   <img src="<%- products[shopping_cart.product_id].img.location %>" alt="">
                               <% }else{ %>
                                   <img src="{{static_host}}/images/no_picture.png" alt="">
                               <% } %>
                            <% }else{ %>
                                <img src="{{static_host}}/images/no_picture.png" alt="">
                            <% } %>
                       </a>
                   </span>

                  <div class="infor">
                    <p class="infor-one"><%- products[shopping_cart.product_id].product_name %></p>
                    <p class="infor-two"></p>
                    <div class="infor-three">
                        <span class="price">￥</span>
                        <span class="price red"><%- products[shopping_cart.product_id].product_sale_price %></span>
                        <span>库存:  <%- stock_map[shopping_cart.product_id]%></span>
                        <% if(products[shopping_cart.product_id].is_down ==1){ %>已下架 <% } %>
                        <p class="add">
                            <span  <% if(shopping_cart.total_items <= 1){ %> id="color" <% } %> class="reduce"  data-id="<%- shopping_cart.id %>">-</span>
                            <span>
                                <input type="number" class="update_num" maxlength="2" name="" value="<%- shopping_cart.total_items %>" data-id="<%- shopping_cart.id %>">
                            </span>
                            <span class="plus" data-id="<%- shopping_cart.id %>">+</span>
                        </p>
                        <% if(update_ids[shopping_cart.product_id]){ %>
                         <p class="" style="padding-top: 10px;float: left;">该商品价格已变动</p>
                         <% } %>
                    </div>
                  </div>
                </div>
              </li>
              <% })%>
            <% }); %>
            </ul>
            <div class="footer_zhanwei">没有啦，，，</div>
            <div class="footer">
              <div class="footer-left">
                  <span class="bottom">
                    <% if(selected == 1){ %>
                        <img src="{{static_host}}/images/xuanzhong.png" alt="">
                    <% }else{ %>
                        <img src="{{static_host}}/images/circle.png" alt="">
                    <% } %>
                  </span>
                <span class="all">全选</span>
              </div>
              <div class="footer-center">
                <p class="footer-center-top"><span>合计：</span><span class="footer-span2">￥</span><span class="footer-span2"><%- total_data.total_prices %> </span></p>
                <p class="footer-center-bottom"><span class="footer-span1">总金额：￥<%- total_data.total_prices %></span><span class="footer-span1">立减：0</span></p>
              </div>

              <div class="footer-right">
                <span>去结算</span><span>(<%- total_data.total_items %>)</span>
              </div>
            </div>
        </script>
    </div>
    <script src="{{static_host}}/jquery-3.1.1.min.js"type="text/javascript"></script>
    <script src="{{static_host}}/react.min.js"></script>
    <script src="{{static_host}}/react-dom.min.js"></script>
    <script src="{{static_host}}/browser.min.js"></script>
    <script src="{{static_host}}/js/jinzhi.js"></script>


    <!-- 点击circle更换图片地址 -->
    <script type="text/javascript">
      $(function(){
        $(".circle img").click(function(){
          var circleImg=$(this).attr("src");
          if(circleImg=="{{static_host}}/images/circle.png"){
            $(this).attr("src","{{static_host}}/images/xuanzhong.png");
          }else {
            $(this).attr("src","{{static_host}}/images/circle.png");
          };
        });
        $(".footer .footer-left").click(function(){
          var allImg=$(".footer .footer-left img").attr("src");

            if(allImg=="{{static_host}}/images/circle.png"){
              $(".footer .footer-left img").attr("src","{{static_host}}/images/xuanzhong.png");
                $(".circle img").attr("src","{{static_host}}/images/xuanzhong.png");
            }else {
              $(".footer .footer-left img").attr("src","{{static_host}}/images/circle.png");
                $(".circle img").attr("src","{{static_host}}/images/circle.png");
            }

        })
      })
    </script>


	<script type="text/javascript">
		var delete_model = function(){
			var window_width = $(window).width();
			$(".list_infor").css("max-width",window_width);
			$(".list_infor").css("width",window_width);
            var touchPage;
			var change = 0;
			$(".list_infor")
			.on("touchstart",function(e){
				var touch = e.targetTouches[0];//touches数组对象获得屏幕上所有的touch，取第一个touch
				touchPage=e.targetTouches[0].pageX; //获取第一个点的X坐标
				// alert(touchPage);
			})
			.on("touchmove",function(e){
			  var touch = e.targetTouches[0];//touches数组对象获得屏幕上所有的touch，取第一个touch
			  change=touch.pageX-touchPage;
			  if(change<-100){
				  change=-100;
			  }
        if(change<-50){
            $(this).css("left",change);
            }

			})
			.on("touchend",function(){
			  if(change>-50){
				$(this).animate({"left":"0"},200);
			  }else {
				$(this).animate({"left":"-68px"},50);
			  }
			});
			$('.behind').on('click', function(e) {
				e.preventDefault()
				$(this).parents('li').slideUp('fast', function() {
					$(this).remove()
				})
			})
		};
		$(function() {
			var shopping_carts = {{shopping_carts | safe}};
			var products = {{products | safe}};
			var total_data = {{total_data|safe}};
			var update_ids = {{update_ids | safe}};
			var selected = 0;
            var mendians_list = {{mendians_list | safe}};
            var mendians_map = {{mendians_map | safe}};
            var stock_map = {{stock_map | safe}};
			var all_carts_status = function(){
				var all_selected = 1;
				_.each(shopping_carts,function(shopping_cart) {
					if (shopping_cart.is_selected != 1) {
						all_selected = 0;
					}
				});
				selected = all_selected;
			};
			var fresh_carts = function(){
				if (shopping_carts.length ==0) {
					var t = _.template($("#empty_cart").html());
					$("#carts").html(t());
					return;
				}
				all_carts_status();
				var t = _.template($("#cart_infos").html());
				$("#carts").html(t({shopping_carts:shopping_carts,products:products,update_ids:update_ids,total_data:total_data,selected:selected,mendians_list:mendians_list,mendians_map:mendians_map,stock_map:stock_map}));
				delete_model();
				$(".circle").click(function(){
					var selected = $(this).data("select");
					var id = $(this).data("id");
					update_selected(selected,id);
				});
				$(".footer-left").click(function(){
					if (selected == 0) {
 					   selected = 1;
 				   }else {
 				   	  selected = 0;
 				   }
					var ids = [];
					_.forEach(shopping_carts, function(shopping_cart) {
						ids.push(shopping_cart.id);
				   });
				   update_selected2(selected,ids);
				});
				$(".footer-right").click(function(){
					var ids = [];
                    var selected_map = {};
					_.forEach(shopping_carts, function(shopping_cart) {
						if (shopping_cart.is_selected == 1) {
                            selected_map[shopping_cart.id] = shopping_cart;
							ids.push(shopping_cart.id);
						}
				   });
                   var over_product_ids = [];
                   var num_flag = 0;
                   for (var i = 0; i < ids.length; i++) {
                       var cart_id = ids[i]
                       var buy_num = selected_map[cart_id].total_items;
                       var stock_num = stock_map[selected_map[cart_id].product_id];
                       if (stock_num<buy_num) {
                           over_product_ids.push(selected_map[cart_id].product_id);
                           num_flag = 1;
                           break;
                       }
                   }
                   if (num_flag == 1) {
                       alert("商品没有足够库存，不能结算！");
                       console.log("product_id:"+over_product_ids);
                       return;
                   }
                   if (ids.length>0) {
                       location.href = "/place_order?ids="+JSON.stringify(ids);
                   }else {
                       alert("请选择商品！");
                   }
				});
				$(".delete").click(function(){
					var id = $(this).data("id");
					$.get("/delete_cart",{id:id},function(data){
						if (data.success) {
							shopping_carts = data.shopping_carts;
							total_data = data.total_data;
                            mendians_list = data.mendians_list;
                            mendians_map = data.mendians_map;
							fresh_carts();
						}
					});
				});
				$(".plus").click(function(){
					var id = $(this).data("id");
					$.post("/plus_cart",{id:id},function(data){
						if (data.success) {
							shopping_carts = data.shopping_carts;
							total_data = data.total_data;
                            mendians_list = data.mendians_list;
                            mendians_map = data.mendians_map;
							fresh_carts();
						}
					});
				});
				$(".reduce").click(function(){
					var id = $(this).data("id");
					$.post("/reduce_cart",{id:id},function(data){
						if (data.success) {
							shopping_carts = data.shopping_carts;
							total_data = data.total_data;
                            mendians_list = data.mendians_list;
                            mendians_map = data.mendians_map;
							fresh_carts();
						}
					});
				});
				$(".update_num").click(function(){
					$(this).select();
					$(this).keypress(function(e){
						var id = $(this).data("id");
						var key = e.which; //e.which是按键的值
						if (key == 13) {
							var num = $(this).val();
							if (!num || !id) {
								return;
							}
							if (num <= 0) {
								alert("数量输入有误");
							}
							$.post("/update_cart_number",{id:id,num:num},function(data){
								if (data.success) {
									shopping_carts = data.shopping_carts;
									total_data = data.total_data;
                                    mendians_list = data.mendians_list;
                                    mendians_map = data.mendians_map;
									fresh_carts();
								}
							});
						}
					});
				});
			};
			fresh_carts();
			//单选
			var update_selected = function(selected,id){
				var ids = [];
				ids.push(id.toString());
				if (selected == 1) {
					selected = 0;
				}else {
					selected = 1;
				}
				$.get("/update_cart",{ids:JSON.stringify(ids),selected:selected},function(data){
					if (data.success) {
						shopping_carts = data.shopping_carts;
						total_data = data.total_data;
                        mendians_list = data.mendians_list;
                        mendians_map = data.mendians_map;
						fresh_carts();
					}else {
					}
				});
			};
			//多选
			var update_selected2 = function(selected,ids){
				$.get("/update_cart",{ids:JSON.stringify(ids),selected:selected},function(data){
					if (data.success) {
						shopping_carts = data.shopping_carts;
						total_data = data.total_data;
                        mendians_list = data.mendians_list;
                        mendians_map = data.mendians_map;
						fresh_carts();
					}else {
					}
				});
			};
			$(".head .menu").click(function(){
				$(".nav").toggle();
			});

        // 返回上一层
        $(".head .jiantou").click(function(){
            window.history.back();
        })

        // var viewHeight = $('body').height();
        // var ulHeight = (viewHeight-137)+'px';
        // alert(ulHeight);
        // $('.list').css('height',ulHeight);

  		});
    </script>
  </body>
</html>
